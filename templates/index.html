<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Action Recognition System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .header {
            text-align: center;
            color: #ffffff;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            color: #ffffff;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header .subtitle {
            font-size: 1.1em;
            color: #b0b0b0;
            font-weight: 300;
        }
        
        .credits {
            text-align: center;
            color: #b0b0b0;
            margin-bottom: 20px;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .credits strong {
            font-weight: 600;
            color: #ffffff;
        }
        
        .supervision {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.85em;
            font-style: italic;
        }
        
        .container {
            background: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid #2a2a2a;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #2a2a2a;
        }
        
        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            color: #888;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }
        
        .tab:hover {
            color: #ffffff;
        }
        
        .tab.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed #3a3a3a;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            background: #0f0f0f;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 25px;
        }
        
        .upload-area:hover {
            border-color: #4a9eff;
            background: #151515;
        }
        
        .upload-area.dragover {
            border-color: #4a9eff;
            background: #1a1a1a;
            transform: scale(1.01);
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 20px;
            color: #4a9eff;
            font-weight: 300;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .upload-hint {
            color: #888;
            font-size: 0.9em;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #1a3a1a;
            border-radius: 10px;
            border: 1px solid #2a5a2a;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .file-name {
            font-weight: 600;
            color: #4caf50;
        }
        
        .file-size {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .camera-preview {
            width: 100%;
            max-width: 640px;
            height: 480px;
            background: #000;
            border-radius: 10px;
            margin: 20px auto;
            display: none;
            position: relative;
            overflow: hidden;
            border: 2px solid #2a2a2a;
        }
        
        .camera-preview.show {
            display: block;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #e0e0e0;
            font-weight: 600;
            font-size: 1.05em;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #2a2a2a;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
            background: #0f0f0f;
            color: #e0e0e0;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }
        
        .form-hint {
            font-size: 0.85em;
            color: #888;
            margin-top: 8px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.15em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(74, 158, 255, 0.3);
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
            background: linear-gradient(135deg, #5aaeff 0%, #0077dd 100%);
        }
        
        .submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            background: #2a2a2a;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            padding: 12px 25px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 2px solid #3a3a3a;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-secondary:hover {
            background: #3a3a3a;
            border-color: #4a9eff;
            color: #ffffff;
        }
        
        .btn-secondary.danger {
            background: #5a1a1a;
            border-color: #7a2a2a;
            color: #ff6b6b;
        }
        
        .btn-secondary.danger:hover {
            background: #6a2a2a;
            border-color: #9a3a3a;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 5px solid #2a2a2a;
            border-top: 5px solid #4a9eff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.1em;
            color: #b0b0b0;
            font-weight: 500;
        }
        
        .result {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: #0f0f0f;
            border-radius: 15px;
            border: 1px solid #2a2a2a;
        }
        
        .result.show {
            display: block;
        }
        
        .result-title {
            font-size: 1.8em;
            color: #ffffff;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .result-content {
            background: #0a0a0a;
            padding: 25px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.8;
            border: 1px solid #2a2a2a;
            color: #d0d0d0;
        }
        
        .error {
            background: #3a1a1a;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            border: 2px solid #5a2a2a;
        }
        
        .error.show {
            display: block;
        }
        
        .download-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: #2a5a2a;
            color: #4caf50;
            border: 2px solid #3a6a3a;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1.05em;
        }
        
        .download-btn:hover {
            background: #3a6a3a;
            border-color: #4a7a4a;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }

        /* Chat bots */
        .chat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .chat-card {
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
        }

        .chat-card h3 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        .chat-messages {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 15px;
            height: 260px;
            overflow-y: auto;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            color: #d0d0d0;
        }

        .chat-message {
            margin-bottom: 12px;
        }

        .chat-message .sender {
            font-weight: 700;
            color: #4a9eff;
            margin-right: 6px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #2a2a2a;
            background: #0f0f0f;
            color: #e0e0e0;
            resize: vertical;
            min-height: 70px;
        }

        .chat-input button {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background: #4a9eff;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            min-width: 110px;
        }

        /* Floating guide bot toggle */
        .copilot-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #111;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            z-index: 1200;
        }

        .copilot-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 360px;
            max-width: 90vw;
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.5);
            padding: 16px;
            display: none;
            z-index: 1200;
        }

        .copilot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .copilot-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        
        #recordingIndicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #5a1a1a;
            color: #ff4444;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            border: 2px solid #7a2a2a;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI Action Recognition System</h1>
        <p class="subtitle">Advanced Video Analysis Powered by AI Vision Models</p>
    </div>
    
    <div class="credits">
        <strong>Developed by:</strong> Khaled gahwlash, mohamed gamal and Rawan mohamed , mostafa hazem 
    </div>
    
    <div class="supervision">
        Under the supervision of Dr. hamdy and eng yahia 
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="upload">Upload Video</button>
            <button class="tab" data-tab="camera">Live Camera</button>
            <button class="tab" data-tab="chat">Chat Assistants</button>
        </div>
        
        <!-- Upload Tab -->
        <div class="tab-content active" id="upload-tab">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">UPLOAD</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-hint">Supports: MP4, AVI, MOV, MKV, FLV, WMV, WEBM (Max 500MB)</div>
                    <input type="file" id="videoFile" name="video" accept="video/*">
                </div>
                
                <div class="file-info" id="fileInfo">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
                
                <div class="form-group">
                    <label for="frameInterval">Frame Interval</label>
                    <input type="number" id="frameInterval" name="frame_interval" value="30" min="1" max="300">
                    <div class="form-hint">Analyze every N frames (lower = more detailed but slower, default: 30)</div>
                </div>
                
                <div class="form-group">
                    <label for="model">Model (Optional)</label>
                    <input type="text" id="model" name="model" placeholder="Leave empty for default model">
                    <div class="form-hint">Default: meta-llama/llama-4-scout-17b-16e-instruct</div>
                </div>
                
                <button type="submit" class="submit-btn" id="uploadBtn">Analyze Video</button>
            </form>
        </div>
        
        <!-- Camera Tab -->
        <div class="tab-content" id="camera-tab">
            <div class="camera-preview" id="cameraPreview">
                <video id="videoStream" autoplay playsinline></video>
                <div id="recordingIndicator" style="display:none;">RECORDING</div>
            </div>
            
            <div class="camera-controls">
                <button class="btn-secondary" id="startCameraBtn">Start Camera</button>
                <button class="btn-secondary" id="stopCameraBtn" style="display:none;">Stop Camera</button>
                <button class="btn-secondary danger" id="recordBtn" style="display:none;">Record Video</button>
                <button class="btn-secondary danger" id="stopRecordBtn" style="display:none;">Stop Recording</button>
            </div>
            
            <div class="file-info" id="recordedVideoInfo" style="display:none;">
                <div class="file-name" id="recordedVideoName">Video recorded and saved!</div>
                <div class="file-size" id="recordedVideoSize"></div>
            </div>
            
            <form id="cameraForm">
                <div class="form-group">
                    <label for="cameraDuration">Recording Duration (seconds)</label>
                    <input type="number" id="cameraDuration" name="duration" value="30" min="5" max="300">
                    <div class="form-hint">How long to record video (default: 30 seconds)</div>
                </div>
                
                <div class="form-group">
                    <label for="cameraFrameInterval">Frame Interval</label>
                    <input type="number" id="cameraFrameInterval" name="frame_interval" value="30" min="1" max="300">
                    <div class="form-hint">Analyze every N frames (lower = more detailed but slower, default: 30)</div>
                </div>
                
                <div class="form-group">
                    <label for="cameraModel">Model (Optional)</label>
                    <input type="text" id="cameraModel" name="model" placeholder="Leave empty for default model">
                    <div class="form-hint">Default: meta-llama/llama-4-scout-17b-16e-instruct</div>
                </div>
                
                <button type="submit" class="submit-btn" id="cameraBtn" disabled>Start Analysis</button>
            </form>
        </div>

        <!-- Chat Assistants Tab -->
        <div class="tab-content" id="chat-tab">
            <div class="chat-grid">
                <div class="chat-card">
                    <h3>Report Q&A (uses openai/gpt-oss-120b)</h3>
                    <div class="form-group">
                        <label for="reportSelect">Select report to reference</label>
                        <select id="reportSelect" style="width:100%;padding:12px;border-radius:10px;border:2px solid #2a2a2a;background:#0f0f0f;color:#e0e0e0;">
                            <option value="">Latest report (if any)</option>
                        </select>
                        <div style="margin-top:8px;">
                            <button type="button" class="btn-secondary" id="refreshReportsBtn">Refresh list</button>
                        </div>
                        <div class="form-hint">Pick a generated .txt report to ground answers.</div>
                    </div>
                    <div class="chat-messages" id="reportMessages"></div>
                    <form id="reportChatForm" class="chat-input">
                        <textarea id="reportMessage" placeholder="Ask about actions, events, people..."></textarea>
                        <button type="submit" id="reportSendBtn">Send</button>
                    </form>
                    <button type="button" class="btn-secondary" id="reportSpeakBtn" style="margin-top:10px;width:100%;">ðŸ”Š Speak last reply</button>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p class="loading-text">Processing video... This may take a few minutes.</p>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="result" id="result">
            <div class="result-title">Analysis Report</div>
            <div class="result-content" id="resultContent"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                <a href="#" class="download-btn" id="downloadBtn" download>Download Report</a>
                <a href="#" class="download-btn" id="downloadSummaryBtn" download>Download Summary PDF</a>
            </div>
        </div>
    </div>
    
    <!-- Floating Report Bot (available on all pages) -->
    <button class="copilot-toggle" id="copilotToggle" title="Report Bot">ðŸ’¬</button>
    <div class="copilot-panel" id="copilotPanel">
        <div class="copilot-header">
            <div style="font-weight:700;color:#fff;">Report Bot</div>
            <button class="copilot-close" id="copilotClose">âœ•</button>
        </div>
        <div class="form-group" style="margin-bottom:10px;">
            <label for="copilotReportSelect" style="margin-bottom:6px;">Report</label>
            <select id="copilotReportSelect" style="width:100%;padding:10px;border-radius:10px;border:2px solid #2a2a2a;background:#0f0f0f;color:#e0e0e0;">
                <option value="">Latest report (if any)</option>
            </select>
        </div>
        <div class="chat-messages" id="copilotMessages" style="height:200px;"></div>
        <form id="copilotChatForm" class="chat-input" style="margin-top:10px;">
            <textarea id="copilotMessage" placeholder="Ask about the selected report..."></textarea>
            <button type="submit" id="copilotSendBtn">Send</button>
        </form>
        <button type="button" class="btn-secondary" id="copilotSpeakBtn" style="margin-top:10px;width:100%;">ðŸ”Š Speak last reply</button>
    </div>
    
    <script>
        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${targetTab}-tab`).classList.add('active');
                
                // Stop camera if switching away from camera tab
                if (targetTab !== 'camera' && stream) {
                    stopCamera();
                }
            });
        });
        
        // Upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('videoFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadForm = document.getElementById('uploadForm');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateFileInfo(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                updateFileInfo(e.target.files[0]);
            }
        });
        
        function updateFileInfo(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!fileInput.files.length) {
                showError('Please select a video file');
                return;
            }
            
            const formData = new FormData(uploadForm);
            
            hideResults();
            showLoading();
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult(data.report, data.report_file);
                } else {
                    showError(data.error || 'An error occurred');
                }
            } catch (err) {
                showError('Network error: ' + err.message);
            } finally {
                hideLoading();
                document.getElementById('uploadBtn').disabled = false;
            }
        });
        
        // Camera functionality
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordedVideoBlob = null;
        let recordedVideoFile = null;
        
        const videoStream = document.getElementById('videoStream');
        const cameraPreview = document.getElementById('cameraPreview');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopRecordBtn = document.getElementById('stopRecordBtn');
        const cameraForm = document.getElementById('cameraForm');
        const cameraBtn = document.getElementById('cameraBtn');
        const recordedVideoInfo = document.getElementById('recordedVideoInfo');
        const recordedVideoName = document.getElementById('recordedVideoName');
        const recordedVideoSize = document.getElementById('recordedVideoSize');
        const reportMessages = document.getElementById('reportMessages');
        const reportChatForm = document.getElementById('reportChatForm');
        const reportMessageInput = document.getElementById('reportMessage');
        const reportSendBtn = document.getElementById('reportSendBtn');
        const reportSelect = document.getElementById('reportSelect');
        const refreshReportsBtn = document.getElementById('refreshReportsBtn');
        const reportSpeakBtn = document.getElementById('reportSpeakBtn');
        const downloadSummaryBtn = document.getElementById('downloadSummaryBtn');
        const copilotToggle = document.getElementById('copilotToggle');
        const copilotPanel = document.getElementById('copilotPanel');
        const copilotClose = document.getElementById('copilotClose');
        const copilotMessages = document.getElementById('copilotMessages');
        const copilotChatForm = document.getElementById('copilotChatForm');
        const copilotMessageInput = document.getElementById('copilotMessage');
        const copilotSendBtn = document.getElementById('copilotSendBtn');
        const copilotSpeakBtn = document.getElementById('copilotSpeakBtn');
        const copilotReportSelect = document.getElementById('copilotReportSelect');
        let lastReportReply = '';
        let lastCopilotReply = '';
        
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                videoStream.srcObject = stream;
                cameraPreview.classList.add('show');
                startCameraBtn.style.display = 'none';
                stopCameraBtn.style.display = 'inline-block';
                recordBtn.style.display = 'inline-block';
            } catch (err) {
                showError('Could not access camera: ' + err.message);
            }
        });
        
        stopCameraBtn.addEventListener('click', stopCamera);
        
        function stopCamera() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                videoStream.srcObject = null;
                cameraPreview.classList.remove('show');
                recordingIndicator.style.display = 'none';
                startCameraBtn.style.display = 'inline-block';
                stopCameraBtn.style.display = 'none';
                recordBtn.style.display = 'none';
                stopRecordBtn.style.display = 'none';
                cameraBtn.disabled = true;
                recordedVideoInfo.style.display = 'none';
                recordedVideoBlob = null;
                recordedVideoFile = null;
            }
        }
        
        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        
        function startRecording() {
            if (!stream) {
                showError('Please start the camera first');
                return;
            }
            
            recordedChunks = [];
            const options = { mimeType: 'video/webm;codecs=vp9' };
            
            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                try {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                } catch (e2) {
                    mediaRecorder = new MediaRecorder(stream);
                }
            }
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = async () => {
                recordedVideoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                recordedVideoFile = new File([recordedVideoBlob], `recorded_${Date.now()}.webm`, { type: 'video/webm' });
                
                // Save video to server
                await saveRecordedVideo();
            };
            
            const duration = parseInt(document.getElementById('cameraDuration').value) * 1000;
            mediaRecorder.start();
            recordingIndicator.style.display = 'block';
            recordBtn.style.display = 'none';
            stopRecordBtn.style.display = 'inline-block';
            
            // Auto-stop after duration
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    stopRecording();
                }
            }, duration);
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                recordingIndicator.style.display = 'none';
                recordBtn.style.display = 'inline-block';
                stopRecordBtn.style.display = 'none';
            }
        }
        
        async function saveRecordedVideo() {
            if (!recordedVideoBlob || !recordedVideoFile) {
                showError('No video recorded');
                return;
            }
            
            const formData = new FormData();
            formData.append('video', recordedVideoFile);
            
            try {
                showLoading();
                const response = await fetch('/save_recorded_video', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    recordedVideoName.textContent = `Video saved: ${data.video_file}`;
                    recordedVideoSize.textContent = formatFileSize(recordedVideoBlob.size);
                    recordedVideoInfo.classList.add('show');
                    recordedVideoInfo.style.display = 'block';
                    cameraBtn.disabled = false;
                } else {
                    showError(data.error || 'Failed to save video');
                }
            } catch (err) {
                showError('Error saving video: ' + err.message);
            } finally {
                hideLoading();
            }
        }
        
        cameraForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!recordedVideoFile) {
                showError('Please record a video first');
                return;
            }
            
            // Create form data with the recorded video
            const formData = new FormData();
            formData.append('video', recordedVideoFile);
            formData.append('frame_interval', document.getElementById('cameraFrameInterval').value);
            const model = document.getElementById('cameraModel').value;
            if (model) {
                formData.append('model', model);
            }
            
            hideResults();
            showLoading();
            cameraBtn.disabled = true;
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult(data.report, data.report_file);
                } else {
                    showError(data.error || 'An error occurred');
                }
            } catch (err) {
                showError('Network error: ' + err.message);
            } finally {
                hideLoading();
                cameraBtn.disabled = false;
            }
        });

        // Chat assistants
        function appendChatMessage(container, sender, text) {
            const div = document.createElement('div');
            div.classList.add('chat-message');
            div.innerHTML = `<span class="sender">${sender}:</span> ${text}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function speakText(text, button) {
            if (!text) {
                showError('Nothing to speak yet.');
                return;
            }
            if (button) button.disabled = true;
            try {
                const res = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    showError(err.error || 'TTS failed');
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.play();
            } catch (err) {
                showError('TTS error: ' + err.message);
            } finally {
                if (button) button.disabled = false;
            }
        }

        async function loadReportList() {
            try {
                const res = await fetch('/reports/list');
                const data = await res.json();
                const fills = [reportSelect, copilotReportSelect].filter(Boolean);
                fills.forEach(sel => {
                    sel.innerHTML = '';
                    if (data.success && data.reports.length) {
                        data.reports.forEach((name, idx) => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = idx === 0 ? `Latest: ${name}` : name;
                            sel.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'No reports yet. Run an analysis first.';
                        sel.appendChild(opt);
                    }
                });
            } catch (err) {
                const fills = [reportSelect, copilotReportSelect].filter(Boolean);
                fills.forEach(sel => {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Could not load reports';
                    sel.innerHTML = '';
                    sel.appendChild(opt);
                });
            }
        }

        refreshReportsBtn.addEventListener('click', loadReportList);

        reportChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = reportMessageInput.value.trim();
            if (!message) {
                showError('Please type a question for the report bot.');
                return;
            }

            appendChatMessage(reportMessages, 'You', message);
            reportMessageInput.value = '';
            reportSendBtn.disabled = true;

            try {
                const payload = {
                    message,
                    report_file: reportSelect.value || null
                };
                const res = await fetch('/chat/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    appendChatMessage(reportMessages, 'Report Bot', data.reply);
                    lastReportReply = data.reply;
                } else {
                    appendChatMessage(reportMessages, 'System', data.error || 'Chat failed');
                }
            } catch (err) {
                appendChatMessage(reportMessages, 'System', 'Network error: ' + err.message);
            } finally {
                reportSendBtn.disabled = false;
            }
        });

        reportSpeakBtn.addEventListener('click', () => speakText(lastReportReply, reportSpeakBtn));

        // Initial data
        loadReportList();
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        // Copilot floating panel (Report bot)
        copilotToggle.addEventListener('click', () => {
            copilotPanel.style.display = copilotPanel.style.display === 'block' ? 'none' : 'block';
        });
        copilotClose.addEventListener('click', () => {
            copilotPanel.style.display = 'none';
        });

        copilotChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = copilotMessageInput.value.trim();
            if (!message) {
                showError('Please type a question for the report bot.');
                return;
            }

            appendChatMessage(copilotMessages, 'You', message);
            copilotMessageInput.value = '';
            copilotSendBtn.disabled = true;

            try {
                const payload = {
                    message,
                    report_file: copilotReportSelect.value || null
                };
                const res = await fetch('/chat/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    appendChatMessage(copilotMessages, 'Report Bot', data.reply);
                    lastCopilotReply = data.reply;
                } else {
                    appendChatMessage(copilotMessages, 'System', data.error || 'Chat failed');
                }
            } catch (err) {
                appendChatMessage(copilotMessages, 'System', 'Network error: ' + err.message);
            } finally {
                copilotSendBtn.disabled = false;
            }
        });

        copilotSpeakBtn.addEventListener('click', () => speakText(lastCopilotReply, copilotSpeakBtn));
        
        // Utility functions
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        function notifySuccess(title, body) {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                new Notification(title, { body });
            }
        }

        function showResult(report, reportFile) {
            document.getElementById('resultContent').textContent = report;
            document.getElementById('downloadBtn').href = `/report/${reportFile}`;
            downloadSummaryBtn.href = `/report/pdf/${reportFile}`;
            document.getElementById('result').classList.add('show');
            document.getElementById('error').classList.remove('show');
            notifySuccess('Report ready', `Report ${reportFile} is ready.`);
        }
        
        function hideResults() {
            document.getElementById('result').classList.remove('show');
            document.getElementById('error').classList.remove('show');
        }
    </script>
</body>
</html>

